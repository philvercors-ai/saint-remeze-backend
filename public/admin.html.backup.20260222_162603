<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Saint-Rem√®ze</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: #1e293b; }

        /* Connexion */
        #loginSection { height: 100vh; display: flex; align-items: center; justify-content: center; background: #1e293b; }
        .login-card { background: white; padding: 2rem; border-radius: 1rem; width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        /* Dashboard */
        .header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 10; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { font-size: 2rem; margin-bottom: 0.5rem; }

        .filters { background: white; padding: 1rem; border-radius: 0.75rem; margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f1f5f9; font-weight: 600; }

        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: 0.2s; text-decoration: none; display: inline-block; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: #64748b; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 100; padding: 1rem; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 1rem; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }

        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-family: inherit; }
    </style>
</head>
<body>

    <div id="loginSection">
        <div class="login-card">
            <h2 style="margin-bottom: 1.5rem; text-align: center;">Administration</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" value="admin@saint-remeze.fr" required>
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="loginPassword" value="admin123" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Se connecter</button>
            </form>
        </div>
    </div>

    <div id="adminSection" style="display: none;">
        <div class="header">
            <div><h1 style="font-size: 1.25rem;">Saint-Rem√®ze - Gestion</h1></div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-success" onclick="exportPDF()">üìÑ PDF (Mod√®le OK)</button>
                <button class="btn btn-secondary" onclick="exportCSV()">üìä CSV</button>
                <button class="btn btn-danger" onclick="logout()">D√©connexion</button>
            </div>
        </div>

        <div class="container">
            <div class="stats-grid">
                <div class="stat-card"><h3 id="statTotal">0</h3><p>Total</p></div>
                <div class="stat-card"><h3 id="statAttente" style="color: var(--warning);">0</h3><p>En attente</p></div>
                <div class="stat-card"><h3 id="statCours" style="color: var(--primary);">0</h3><p>En cours</p></div>
                <div class="stat-card"><h3 id="statFini" style="color: var(--success);">0</h3><p>Termin√©es</p></div>
            </div>

            <div class="filters">
                <input type="text" id="search" placeholder="Rechercher..." onkeyup="filterTable()" style="flex: 1; min-width: 200px; padding: 0.6rem; border-radius: 4px; border: 1px solid #cbd5e1;">
                <select id="statusFilter" onchange="filterTable()" style="padding: 0.6rem; border-radius: 4px; border: 1px solid #cbd5e1;">
                    <option value="">Tous les statuts</option>
                    <option value="En attente">En attente</option>
                    <option value="En cours">En cours</option>
                    <option value="Termin√©e">Termin√©e</option>
                    <option value="Rejet√©e">Rejet√©e</option>
                </select>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Citoyen</th>
                        <th>Titre</th>
                        <th>Statut</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-bottom: 0.5rem;">D√©tails</h2>
            <p id="modalCategory" style="color: #64748b; margin-bottom: 1rem; font-size: 14px;"></p>
            
            <form id="editForm">
                <input type="hidden" id="editId">
                
                <!-- Informations de la remarque -->
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 0.5rem;">üìã Informations</h3>
                    <div id="remarkInfo" style="font-size: 13px; color: #475569;"></div>
                </div>
                
                <!-- Description -->
                <div class="form-group">
                    <label style="font-weight: 600;">Description</label>
                    <div id="remarkDescription" style="padding: 0.75rem; background: #f8fafc; border-radius: 6px; min-height: 60px; font-size: 14px; color: #334155; line-height: 1.6;"></div>
                </div>
                
                <!-- Photo -->
                <div id="photoSection" style="display: none; margin-bottom: 1rem;">
                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">üì∏ Photo</label>
                    <div id="imagePreview" style="border-radius: 8px; overflow: hidden;"></div>
                </div>
                
                <!-- Localisation -->
                <div id="locationSection" style="display: none; margin-bottom: 1rem;">
                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">üìç Localisation</label>
                    <div id="remarkLocation" style="padding: 0.75rem; background: #f0f9ff; border-radius: 6px; font-size: 13px; font-family: monospace;"></div>
                </div>
                
                <!-- Gestion admin -->
                <div style="border-top: 2px solid #e2e8f0; padding-top: 1rem; margin-top: 1rem;">
                    <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 1rem;">‚öôÔ∏è Gestion</h3>
                    
                    <div class="form-group">
                        <label>Statut</label>
                        <select id="editStatus">
                            <option value="En attente">En attente</option>
                            <option value="En cours">En cours</option>
                            <option value="Termin√©e">Termin√©e</option>
                            <option value="Rejet√©e">Rejet√©e</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Assign√© √†</label>
                        <input type="text" id="editAssign" placeholder="Nom du responsable">
                    </div>
                    <div class="form-group">
                        <label>Notes Admin</label>
                        <textarea id="editNotes" rows="3" placeholder="Notes internes..."></textarea>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <button type="button" class="btn btn-primary" onclick="saveEdit()">üíæ Enregistrer</button>
                    <button type="button" class="btn btn-danger" onclick="deleteRemark()">üóëÔ∏è Supprimer</button>
                    <button type="button" class="btn" onclick="closeModal()" style="background: #e2e8f0; margin-left: auto;">Fermer</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        const API_URL = 'https://saint-remeze-backend.onrender.com';
        let allData = [];

        // --- AUTH ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const res = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, password})
                });
                const data = await res.json();
                if(data.success && data.data.user.role === 'admin') {
                    localStorage.setItem('adminToken', data.data.token);
                    initDashboard();
                } else { alert("Acc√®s refus√©."); }
            } catch(err) { alert("Erreur de connexion."); }
        });

        function logout() { localStorage.removeItem('adminToken'); location.reload(); }

        // --- DASHBOARD ---
        async function initDashboard() {
            const token = localStorage.getItem('adminToken');
            if(!token) return;
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            await loadData();
        }

        async function loadData() {
            const token = localStorage.getItem('adminToken');
            try {
                const res = await fetch(`${API_URL}/api/remarks/admin/all`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const json = await res.json();
                allData = json.data || [];
                updateUI();
            } catch(e) { console.error(e); }
        }

        function updateUI() {
            document.getElementById('statTotal').innerText = allData.length;
            document.getElementById('statAttente').innerText = allData.filter(d => d.status === 'En attente').length;
            document.getElementById('statCours').innerText = allData.filter(d => d.status === 'En cours').length;
            document.getElementById('statFini').innerText = allData.filter(d => d.status === 'Termin√©e').length;
            renderTable(allData);
        }

        function renderTable(data) {
            const body = document.getElementById('tableBody');
            body.innerHTML = data.map(r => `
                <tr>
                    <td>${new Date(r.createdAt).toLocaleDateString()}</td>
                    <td>${r.name}</td>
                    <td>${r.title}</td>
                    <td><span style="font-weight:bold; color:${r.status === 'Termin√©e' ? 'green' : (r.status === 'Rejet√©e' ? 'red' : 'orange')}">${r.status}</span></td>
                    <td><button class="btn btn-primary" style="padding:4px 8px;" onclick="openEdit('${r._id}')">Voir</button></td>
                </tr>
            `).join('');
        }

        function filterTable() {
            const s = document.getElementById('search').value.toLowerCase();
            const f = document.getElementById('statusFilter').value;
            const filtered = allData.filter(r => 
                (r.title.toLowerCase().includes(s) || r.name.toLowerCase().includes(s)) &&
                (f === "" || r.status === f)
            );
            renderTable(filtered);
        }

        // --- ACTIONS ---
        function openEdit(id) {
            const r = allData.find(x => x._id === id);
            if (!r) return;
            
            // Titre et cat√©gorie
            document.getElementById('modalTitle').innerText = r.title;
            document.getElementById('modalCategory').innerText = `Cat√©gorie: ${r.category}`;
            
            // Informations g√©n√©rales
            const userName = r.user?.name || r.name || 'Anonyme';
            const userEmail = r.user?.email || r.email || 'N/A';
            const createdDate = new Date(r.createdAt).toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            document.getElementById('remarkInfo').innerHTML = `
                <div style="margin-bottom: 6px;"><strong>Citoyen:</strong> ${userName}</div>
                <div style="margin-bottom: 6px;"><strong>Email:</strong> ${userEmail}</div>
                <div><strong>Date:</strong> ${createdDate}</div>
            `;
            
            // Description
            document.getElementById('remarkDescription').innerText = r.description || 'Pas de description';
            
            // Photo
            const photoSection = document.getElementById('photoSection');
            const photoUrl = r.photoUrl || r.image;
            if (photoUrl) {
                const fullPhotoUrl = photoUrl.startsWith('http') ? photoUrl : `${API_URL}${photoUrl}`;
                document.getElementById('imagePreview').innerHTML = `
                    <img src="${fullPhotoUrl}" 
                         style="max-width: 100%; height: auto; display: block; border-radius: 8px;"
                         onerror="this.parentElement.innerHTML='<p style=\'color:#64748b;padding:1rem;text-align:center;\'>Photo non disponible</p>'">
                `;
                photoSection.style.display = 'block';
            } else {
                photoSection.style.display = 'none';
            }
            
            // Localisation
            const locationSection = document.getElementById('locationSection');
            if (r.location && r.location.coordinates && r.location.coordinates.length === 2) {
                const [lng, lat] = r.location.coordinates;
                document.getElementById('remarkLocation').innerHTML = `
                    <div style="margin-bottom: 8px;">
                        Latitude: ${lat.toFixed(6)}<br>
                        Longitude: ${lng.toFixed(6)}
                    </div>
                    <a href="https://www.google.com/maps?q=${lat},${lng}" 
                       target="_blank" 
                       style="color: #2563eb; text-decoration: none; font-weight: 600;">
                        üó∫Ô∏è Voir sur Google Maps ‚Üí
                    </a>
                `;
                locationSection.style.display = 'block';
            } else {
                locationSection.style.display = 'none';
            }
            
            // Champs admin
            document.getElementById('editId').value = r._id;
            document.getElementById('editStatus').value = r.status;
            document.getElementById('editAssign').value = r.assignedTo || '';
            document.getElementById('editNotes').value = r.adminNotes || '';
            
            // Ouvrir la modal
            document.getElementById('editModal').classList.add('active');
        }
        function closeModal() { document.getElementById('editModal').classList.remove('active'); }

        async function saveEdit() {
            const id = document.getElementById('editId').value;
            const token = localStorage.getItem('adminToken');
            const body = {
                status: document.getElementById('editStatus').value,
                assignedTo: document.getElementById('editAssign').value,
                adminNotes: document.getElementById('editNotes').value
            };
            await fetch(`${API_URL}/api/remarks/admin/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
                body: JSON.stringify(body)
            });
            closeModal(); loadData();
        }

        async function deleteRemark() {
            if(!confirm("Supprimer ce signalement ?")) return;
            const id = document.getElementById('editId').value;
            const token = localStorage.getItem('adminToken');
            await fetch(`${API_URL}/api/remarks/admin/${id}`, {
                method: 'DELETE',
                headers: {'Authorization': `Bearer ${token}`}
            });
            closeModal(); loadData();
        }

        // --- EXPORT CSV ---
        function exportCSV() {
            let csv = "Date,Citoyen,Categorie,Titre,Statut,Description,Assignation,Notes\n";
            allData.forEach(r => {
                const date = new Date(r.createdAt).toLocaleDateString();
                const desc = (r.description || "").replace(/(\r\n|\n|\r)/gm, " ").replace(/"/g, '""');
                csv += `"${date}","${r.name}","${r.category}","${r.title}","${r.status}","${desc}","${r.assignedTo || ''}","${r.adminNotes || ''}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `export-saint-remeze-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- EXPORT PDF (MOD√àLE OK + FOND BLANC) ---
        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ compress: true });
            const pageWidth = doc.internal.pageSize.getWidth();
            const now = new Date();

            const clean = (str) => {
                if(!str) return "N/A";
                return str.replace(/[^\p{L}\p{N}\s,.'\-\/!?;:()]/gu, '').trim();
            };

            async function createChart(labels, data, colors) {
                return new Promise(res => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 400; canvas.height = 400;
                    const ctx = canvas.getContext('2d');
                    
                    // FORCER FOND BLANC
                    ctx.fillStyle = "white";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{ data: data, backgroundColor: colors, borderWidth: 0 }]
                        },
                        options: { 
                            responsive: false, 
                            animation: false, 
                            plugins: { legend: { display: false } }
                        }
                    });
                    setTimeout(() => res(canvas.toDataURL('image/jpeg', 0.9)), 400);
                });
            }

            // PAGE 1 : SYNTH√àSE
            doc.setFontSize(18).setFont('helvetica', 'bold').text("Saint-Rem√®ze", 14, 20);
            doc.setFontSize(11).setFont('helvetica', 'normal').text("ARDECHE", 14, 26);
            doc.setFontSize(16).setFont('helvetica', 'bold').text("Rapport des Remarques", pageWidth / 2, 45, { align: 'center' });
            doc.setFontSize(13).text("Commune de Saint-Rem√®ze", pageWidth / 2, 52, { align: 'center' });
            doc.setFontSize(9).text(`G√©n√©r√© le ${now.toLocaleDateString()} √† ${now.toLocaleTimeString()}`, 14, 65);
            doc.setFontSize(12).setFont('helvetica', 'bold').text("Statistiques globales", 14, 75);
            doc.setFontSize(10).setFont('helvetica', 'normal');
            doc.text(`Total des signalements : ${allData.length}`, 14, 82);
            doc.text(`En attente: ${allData.filter(r => r.status === 'En attente').length}   En cours: ${allData.filter(r => r.status === 'En cours').length}`, 14, 88);
            doc.text(`Termin√©es: ${allData.filter(r => r.status === 'Termin√©e').length} | Rejet√©es: ${allData.filter(r => r.status === 'Rejet√©e').length}`, 14, 94);

            try {
                const statusData = [
                    allData.filter(r => r.status === 'En attente').length,
                    allData.filter(r => r.status === 'En cours').length,
                    allData.filter(r => r.status === 'Termin√©e').length,
                    allData.filter(r => r.status === 'Rejet√©e').length
                ];
                const imgStat = await createChart(['Attente', 'Cours', 'Fini', 'Refus'], statusData, ['#f39c12', '#3498db', '#27ae60', '#e74c3c']);
                doc.addImage(imgStat, 'JPEG', 14, 105, 65, 65);

                const cats = [...new Set(allData.map(r => r.category))];
                const catCounts = cats.map(c => allData.filter(r => r.category === c).length);
                const imgCat = await createChart(cats, catCounts, ['#3498db', '#2ecc71', '#f1c40f', '#e67e22', '#9b59b6']);
                doc.addImage(imgCat, 'JPEG', 110, 105, 65, 65);
                
                doc.setFontSize(11).setFont('helvetica', 'bold').text("R√©partition par cat√©gories :", 110, 178);
                doc.setFontSize(9).setFont('helvetica', 'normal');
                cats.forEach((cat, idx) => {
                    doc.text(`‚Ä¢ ${clean(cat)} : ${allData.filter(r => r.category === cat).length}`, 110, 185 + (idx * 6));
                });
            } catch (e) { console.error(e); }

            // PAGES D√âTAILS
            for (let i = 0; i < allData.length; i++) {
                const r = allData[i];
                doc.addPage();
                doc.setFontSize(9).setFont('helvetica', 'italic').setTextColor(100).text("Mairie de Saint-Rem√®ze - Rapport de signalement", 14, 15);
                doc.setDrawColor(200).line(14, 18, pageWidth - 14, 18);
                doc.setFontSize(15).setFont('helvetica', 'bold').setTextColor(0).text(`${i + 1}. ${clean(r.title)}`, 14, 30);
                doc.setFontSize(11).text("STATUT :", 14, 42);
                const col = r.status === 'Termin√©e' ? [39, 174, 96] : (r.status === 'Rejet√©e' ? [192, 57, 43] : [41, 128, 185]);
                doc.setTextColor(col[0], col[1], col[2]).text(r.status.toUpperCase(), 35, 42);
                doc.setTextColor(0).setFontSize(10).setFont('helvetica', 'normal');
                doc.text(`D√©clarant : ${clean(r.name)}`, 14, 52);
                doc.text(`Cat√©gorie : ${clean(r.category)}`, 110, 52);
                doc.text(`Email : ${r.email || 'N/A'} | T√©l : ${r.phone || 'N/A'}`, 14, 58);
                doc.setDrawColor(230).line(14, 65, pageWidth - 14, 65);
                doc.setFont('helvetica', 'bold').text("Description du d√©clarant :", 14, 75);
                doc.setFont('helvetica', 'normal');
                const splitDesc = doc.splitTextToSize(clean(r.description), pageWidth - 28);
                doc.text(splitDesc, 14, 82);
                let curY = 82 + (splitDesc.length * 5) + 10;
                doc.setFont('helvetica', 'bold').text(`Assign√© √† :`, 14, curY);
                doc.setFont('helvetica', 'normal').text(clean(r.assignedTo) || "Non assign√©", 40, curY);
                curY += 7;
                doc.setFont('helvetica', 'bold').text(`Notes admin :`, 14, curY);
                doc.setFont('helvetica', 'normal').text(clean(r.adminNotes) || "Aucune note.", 40, curY);
                if (r.image) {
                    try {
                        const props = doc.getImageProperties(r.image);
                        const h = (props.height * 120) / props.width;
                        if (curY + 15 + h > 280) doc.addPage(), curY = 20;
                        doc.addImage(r.image, 'JPEG', 14, curY + 15, 120, h);
                    } catch (e) {}
                }
            }
            doc.save(`rapport-muni-${now.toISOString().split('T')[0]}.pdf`);
        }

        if(localStorage.getItem('adminToken')) initDashboard();
    </script>
</body>
</html>