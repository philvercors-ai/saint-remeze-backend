<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Saint-Rem√®ze</title>
    <style>
        /* STYLE GLOBAL */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; color: #333; }
        
        /* HEADER */
        .header { background: #fff; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .logo-area { display: flex; align-items: center; gap: 15px; }
        .logo-area h1 { font-size: 22px; color: #2c3e50; }
        
        /* BUTTONS */
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-success { background: #27ae60; color: white; }
        .btn-primary { background: #2980b9; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn:hover { opacity: 0.8; }

        /* LAYOUT */
        .container { max-width: 1300px; margin: 30px auto; padding: 0 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
        .stat-card h3 { font-size: 28px; margin-bottom: 5px; }
        .stat-card p { color: #7f8c8d; font-size: 14px; }

        /* FILTERS & TABLE */
        .filters { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; }
        .filters select, .filters input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        .table-container { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }

        /* LOGIN */
        #loginSection { height: 100vh; display: flex; justify-content: center; align-items: center; background: #2c3e50; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 100%; max-width: 400px; }
    </style>
</head>
<body>

    <div id="loginSection">
        <div class="login-box">
            <h2 style="text-align: center; margin-bottom: 20px;">Admin Saint-Rem√®ze</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" value="admin@saint-remeze.fr" required>
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="loginPassword" value="admin123" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Se connecter</button>
            </form>
        </div>
    </div>

    <div id="adminSection" style="display: none;">
        <div class="header">
            <div class="logo-area">
                <h1>Saint-Rem√®ze - Dashboard</h1>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="openRgpd('pdf')">üìÑ Export PDF</button>
                <button class="btn btn-success" onclick="openRgpd('csv')">üìä Export CSV</button>
                <button class="btn btn-danger" onclick="logout()">Quitter</button>
            </div>
        </div>

        <div class="container">
            <div class="stats-grid">
                <div class="stat-card"><h3 id="statTotal">0</h3><p>Total</p></div>
                <div class="stat-card"><h3 id="statAttente" style="color: #f39c12;">0</h3><p>En attente</p></div>
                <div class="stat-card"><h3 id="statCours" style="color: #3498db;">0</h3><p>En cours</p></div>
                <div class="stat-card"><h3 id="statTerminee" style="color: #27ae60;">0</h3><p>Termin√©es</p></div>
            </div>

            <div class="filters">
                <input type="text" id="searchBox" placeholder="Rechercher un titre ou nom..." onkeyup="filterData()">
                <select id="filterStatus" onchange="filterData()">
                    <option value="">Tous les statuts</option>
                    <option value="En attente">En attente</option>
                    <option value="En cours">En cours</option>
                    <option value="Termin√©e">Termin√©e</option>
                    <option value="Rejet√©e">Rejet√©e</option>
                </select>
                <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
            </div>

            <div class="table-container">
                <table id="mainTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>D√©clarant</th>
                            <th>Cat√©gorie</th>
                            <th>Titre</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">D√©tails du signalement</h2>
            <hr style="margin: 15px 0;">
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-group"><label>Statut</label>
                    <select id="editStatus">
                        <option value="En attente">En attente</option>
                        <option value="En cours">En cours</option>
                        <option value="Termin√©e">Termin√©e</option>
                        <option value="Rejet√©e">Rejet√©e</option>
                    </select>
                </div>
                <div class="form-group"><label>Assign√© √†</label><input type="text" id="editAssign"></div>
                <div class="form-group"><label>Notes internes</label><textarea id="editNotes" rows="4"></textarea></div>
                <div id="imgPreview" style="margin-bottom: 15px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-primary" onclick="updateRemark()">Enregistrer</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Fermer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="rgpdModal" class="modal">
        <div class="modal-content" style="max-width: 450px; text-align: center;">
            <h3>üõ°Ô∏è Protection des donn√©es</h3>
            <p style="margin: 15px 0; color: #666;">L'export contient des donn√©es personnelles (Email, T√©l). Vous devez les traiter conform√©ment au RGPD.</p>
            <button class="btn btn-success" onclick="startExport()">J'accepte et j'exporte</button>
            <button class="btn btn-secondary" onclick="closeRgpd()">Annuler</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const API_URL = 'https://saint-remeze-backend.onrender.com';
        let allData = [];
        let exportQueueType = '';

        // -- AUTH --
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const res = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, password})
                });
                const data = await res.json();
                if(data.success && data.data.user.role === 'admin') {
                    localStorage.setItem('adminToken', data.data.token);
                    initDashboard();
                } else { alert("Acc√®s refus√©."); }
            } catch(err) { alert("Erreur de connexion."); }
        });

        function logout() { localStorage.removeItem('adminToken'); location.reload(); }

        // -- INIT --
        async function initDashboard() {
            const token = localStorage.getItem('adminToken');
            if(!token) return;
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            await loadData();
        }

        async function loadData() {
            const token = localStorage.getItem('adminToken');
            try {
                const res = await fetch(`${API_URL}/api/remarks/admin/all`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const json = await res.json();
                allData = json.data || [];
                renderTable(allData);
                updateStats();
            } catch(e) { console.error(e); }
        }

        function updateStats() {
            document.getElementById('statTotal').innerText = allData.length;
            document.getElementById('statAttente').innerText = allData.filter(d => d.status === 'En attente').length;
            document.getElementById('statCours').innerText = allData.filter(d => d.status === 'En cours').length;
            document.getElementById('statTerminee').innerText = allData.filter(d => d.status === 'Termin√©e').length;
        }

        function renderTable(data) {
            const body = document.getElementById('tableBody');
            body.innerHTML = data.map(r => `
                <tr>
                    <td>${new Date(r.createdAt).toLocaleDateString()}</td>
                    <td>${r.name}</td>
                    <td>${r.category}</td>
                    <td>${r.title}</td>
                    <td><span class="status-badge" style="background:#eee;">${r.status}</span></td>
                    <td><button class="btn btn-primary" style="padding:5px 10px;" onclick="openEdit('${r._id}')">Voir</button></td>
                </tr>
            `).join('');
        }

        function filterData() {
            const search = document.getElementById('searchBox').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            const filtered = allData.filter(r => {
                const matchSearch = r.title.toLowerCase().includes(search) || r.name.toLowerCase().includes(search);
                const matchStatus = status === "" || r.status === status;
                return matchSearch && matchStatus;
            });
            renderTable(filtered);
        }

        // -- MODALS --
        function openEdit(id) {
            const r = allData.find(x => x._id === id);
            document.getElementById('editId').value = r._id;
            document.getElementById('editStatus').value = r.status;
            document.getElementById('editAssign').value = r.assignedTo || '';
            document.getElementById('editNotes').value = r.adminNotes || '';
            document.getElementById('imgPreview').innerHTML = r.image ? `<img src="${r.image}" style="max-width:100%; border-radius:8px;">` : 'Pas d\'image';
            document.getElementById('editModal').classList.add('active');
        }
        function closeModal() { document.getElementById('editModal').classList.remove('active'); }

        async function updateRemark() {
            const id = document.getElementById('editId').value;
            const token = localStorage.getItem('adminToken');
            const body = {
                status: document.getElementById('editStatus').value,
                assignedTo: document.getElementById('editAssign').value,
                adminNotes: document.getElementById('editNotes').value
            };
            await fetch(`${API_URL}/api/remarks/admin/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
                body: JSON.stringify(body)
            });
            closeModal();
            loadData();
        }

        // -- EXPORT PDF OPTIMIS√â (COMPRESS√â & MOD√àLE PJ) --
        function openRgpd(type) { exportQueueType = type; document.getElementById('rgpdModal').classList.add('active'); }
        function closeRgpd() { document.getElementById('rgpdModal').classList.remove('active'); }
        function startExport() { closeRgpd(); if(exportQueueType==='pdf') exportPDF(); else exportCSV(); }

        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ compress: true });
            const pageWidth = doc.internal.pageSize.getWidth();
            const now = new Date();

            // Utilitaire compression
            async function compress(base64) {
                return new Promise(res => {
                    const img = new Image(); img.src = base64;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if(w > 800) { h = (800/w)*h; w = 800; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img,0,0,w,h);
                        res(canvas.toDataURL('image/jpeg', 0.5));
                    };
                });
            }

            // -- PAGE 1 : SYNTH√àSE (Format Mod√®le) --
            doc.setFontSize(18).setFont('helvetica', 'bold').text("Saint-Rem√®ze", 14, 20);
            doc.setFontSize(11).setFont('helvetica', 'normal').text("ARDECHE", 14, 26);
            doc.setFontSize(16).text("Rapport des Remarques", pageWidth/2, 45, {align:'center'});
            doc.setFontSize(13).text("Commune de Saint-Rem√®ze", pageWidth/2, 52, {align:'center'});
            doc.setFontSize(9).text(`G√©n√©r√© le ${now.toLocaleDateString()} √† ${now.toLocaleTimeString()}`, 14, 65);

            doc.setFontSize(12).setFont('helvetica', 'bold').text("Statistiques globales", 14, 75);
            doc.setFontSize(10).setFont('helvetica', 'normal');
            doc.text(`Total des signalements : ${allData.length}`, 14, 82);
            doc.text(`En attente: ${allData.filter(r=>r.status==='En attente').length} | En cours: ${allData.filter(r=>r.status==='En cours').length}`, 14, 88);
            doc.text(`Termin√©es: ${allData.filter(r=>r.status==='Termin√©e').length} | Rejet√©es: ${allData.filter(r=>r.status==='Rejet√©e').length}`, 14, 94);

            // -- PAGES D√âTAILL√âES --
            for (let i = 0; i < allData.length; i++) {
                const r = allData[i];
                doc.addPage();
                // En-t√™te de page
                doc.setFontSize(9).setFont('helvetica', 'italic').setTextColor(120).text("Mairie de Saint-Rem√®ze - Rapport de signalement", 14, 12);
                doc.setDrawColor(200).line(14, 15, pageWidth-14, 15);
                
                doc.setFontSize(15).setFont('helvetica', 'bold').setTextColor(0).text(`${i+1}. ${r.title || 'Sans titre'}`, 14, 25);
                
                doc.setFontSize(11).text("STATUT :", 14, 35);
                const color = r.status === 'Termin√©e' ? [39, 174, 96] : (r.status === 'Rejet√©e' ? [192, 57, 43] : [41, 128, 185]);
                doc.setTextColor(color[0], color[1], color[2]).text(r.status.toUpperCase(), 35, 35);
                
                doc.setTextColor(0).setFontSize(10);
                doc.text(`D√©clarant : ${r.name}`, 14, 45);
                doc.text(`Cat√©gorie : ${r.category}`, 110, 45);
                doc.text(`Email : ${r.email || 'N/A'} | T√©l : ${r.phone || 'N/A'}`, 14, 51);
                
                doc.setFont('helvetica', 'bold').text("Description du d√©clarant :", 14, 62);
                doc.setFont('helvetica', 'normal');
                const descLines = doc.splitTextToSize(r.description || "Aucune description.", pageWidth - 28);
                doc.text(descLines, 14, 68);
                
                let currentY = 68 + (descLines.length * 5) + 10;
                doc.setFont('helvetica', 'bold').text(`Assign√© √† : ${r.assignedTo || 'Non assign√©'}`, 14, currentY);
                currentY += 7;
                doc.text(`Notes admin : ${r.adminNotes || 'Aucune note.'}`, 14, currentY);
                currentY += 12;

                if (r.image) {
                    try {
                        const lowRes = await compress(r.image);
                        const props = doc.getImageProperties(lowRes);
                        const imgW = 120;
                        const imgH = (props.height * imgW) / props.width;
                        if(currentY + imgH > 280) { doc.addPage(); currentY = 20; }
                        doc.addImage(lowRes, 'JPEG', 14, currentY, imgW, imgH);
                    } catch(e) {}
                }
            }

            const name = `rapport-muni-${now.toISOString().split('T')[0]}.pdf`;
            doc.save(name);
        }

        function exportCSV() {
            let csv = "Date,Nom,Categorie,Titre,Statut,Description\n";
            allData.forEach(r => {
                csv += `"${new Date(r.createdAt).toLocaleDateString()}","${r.name}","${r.category}","${r.title}","${r.status}","${(r.description||'').replace(/"/g,'')}"\n`;
            });
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'export-saint-remeze.csv'; a.click();
        }

        // Check if already logged in
        if(localStorage.getItem('adminToken')) initDashboard();

    </script>
</body>
</html>