<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Saint-Rem√®ze</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8fafc; }
        .header { background: white; border-bottom: 1px solid #e2e8f0; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .logo-container { display: flex; align-items: center; gap: 15px; }
        .logo-container img { height: 50px; }
        .header h1 { color: #1e293b; font-size: 24px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 40px; }
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-value { font-size: 36px; font-weight: bold; }
        .stat-label { color: #64748b; font-size: 14px; margin-top: 8px; }
        .filters { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .filters select, .filters input { padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        .remarks-table { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #e2e8f0; color: #1e293b; }
        tr:hover { background: #f8fafc; }
        .status-badge { padding: 5px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; display: inline-block; }
        .status-en-attente { background: #fef3c7; color: #92400e; }
        .status-en-cours { background: #dbeafe; color: #1e40af; }
        .status-terminee { background: #d1fae5; color: #065f46; }
        .status-rejetee { background: #fee2e2; color: #991b1b; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #1e293b; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #475569; }
        .form-group select, .form-group textarea, .form-group input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .loading { text-align: center; padding: 40px; color: #64748b; }
        .empty { text-align: center; padding: 60px; color: #94a3b8; }
        .login-form { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .login-form h1 { color: #1e293b; margin-bottom: 30px; text-align: center; }
        .error { background: #fee2e2; color: #991b1b; padding: 12px; border-radius: 8px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <!-- SECTION CONNEXION -->
    <div id="loginSection" style="display: none;">
        <div class="login-form">
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="/logo-saint-remeze.png" alt="Saint-Rem√®ze" style="height: 60px;" onerror="this.style.display='none'">
            </div>
            <h1>Admin Saint-Rem√®ze</h1>
            <div id="loginError" class="error" style="display: none;"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required value="admin@saint-remeze.fr">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="loginPassword" required value="admin123">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Se connecter</button>
            </form>
        </div>
    </div>

    <!-- SECTION ADMIN -->
    <div id="adminSection" style="display: none;">
        <div class="header">
            <div class="logo-container">
                <img src="/logo-saint-remeze.png" alt="Saint-Rem√®ze" onerror="this.style.display='none'">
                <h1>Dashboard Admin</h1>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="confirmExport('pdf')">üìÑ Export PDF</button>
                <button class="btn btn-success" onclick="confirmExport('csv')">üìä Export CSV</button>
                <button class="btn btn-secondary" onclick="logout()">D√©connexion</button>
            </div>
        </div>

        <div class="container">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
                <div class="stat-card"><div class="stat-value" style="color: #f59e0b;" id="statEnAttente">0</div><div class="stat-label">En attente</div></div>
                <div class="stat-card"><div class="stat-value" style="color: #3b82f6;" id="statEnCours">0</div><div class="stat-label">En cours</div></div>
                <div class="stat-card"><div class="stat-value" style="color: #10b981;" id="statTerminees">0</div><div class="stat-label">Termin√©es</div></div>
                <div class="stat-card"><div class="stat-value" style="color: #ef4444;" id="statRejetees">0</div><div class="stat-label">Rejet√©es</div></div>
            </div>

            <div class="filters">
                <select id="filterStatus" onchange="loadRemarks()">
                    <option value="">Tous les statuts</option>
                    <option value="En attente">En attente</option>
                    <option value="En cours">En cours</option>
                    <option value="Termin√©e">Termin√©e</option>
                    <option value="Rejet√©e">Rejet√©e</option>
                </select>
                <select id="filterCategory" onchange="loadRemarks()">
                    <option value="">Toutes les cat√©gories</option>
                    <option value="ü§ù Aide √† la personne">ü§ù Aide √† la personne</option>
                    <option value="üöó Circulation / Stationnement">üöó Circulation / Stationnement</option>
                    <option value="üíß Eau et Assainissement">üíß Eau et Assainissement</option>
                    <option value="üí° √âclairage public">üí° √âclairage public</option>
                    <option value="üå≥ Espaces verts">üå≥ Espaces verts</option>
                    <option value="üöÆ Propret√©">üöÆ Propret√©</option>
                    <option value="üöß Travaux / Infrastructure">üöß Travaux / Infrastructure</option>
                    <option value="üì¢ Autre">üì¢ Autre</option>
                </select>
                <input type="text" id="filterSearch" placeholder="Rechercher..." onkeyup="loadRemarks()">
                <button class="btn btn-secondary" onclick="resetFilters()">R√©initialiser</button>
            </div>

            <div class="remarks-table">
                <div id="loading" class="loading">Chargement...</div>
                <div id="empty" class="empty" style="display: none;">
                    <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.5;">üìã</div>
                    <h3>Aucune remarque</h3>
                </div>
                <table id="remarksTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Citoyen</th>
                            <th>Cat√©gorie</th>
                            <th>Titre</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="remarksBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFICATION -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Modifier la remarque</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="editForm" onsubmit="saveRemark(event)">
                <input type="hidden" id="editRemarkId">
                <div class="form-group">
                    <label>Titre</label>
                    <input type="text" id="editTitle" readonly>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editDescription" readonly></textarea>
                </div>
                <div class="form-group">
                    <label>Statut *</label>
                    <select id="editStatus" required>
                        <option value="En attente">En attente</option>
                        <option value="En cours">En cours</option>
                        <option value="Termin√©e">Termin√©e</option>
                        <option value="Rejet√©e">Rejet√©e</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Priorit√©</label>
                    <select id="editPriority">
                        <option value="Basse">Basse</option>
                        <option value="Moyenne">Moyenne</option>
                        <option value="Haute">Haute</option>
                        <option value="Urgente">Urgente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Assign√© √†</label>
                    <input type="text" id="editAssignedTo" placeholder="Service ou personne">
                </div>
                <div class="form-group">
                    <label>Notes administrateur</label>
                    <textarea id="editAdminNotes" placeholder="Notes visibles par le citoyen..."></textarea>
                </div>
                <div id="editImage"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL RGPD -->
    <div id="rgpdModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Consentement RGPD</h2>
                <button class="close-btn" onclick="closeRgpdModal()">&times;</button>
            </div>
            <p style="color: #475569; margin-bottom: 20px;">
                Vous √™tes sur le point d'exporter des donn√©es personnelles (noms, emails, t√©l√©phones des citoyens).
            </p>
            <p style="color: #475569; margin-bottom: 20px;">
                ‚ö†Ô∏è Ces donn√©es sont confidentielles et ne doivent pas √™tre diffus√©es en dehors des services municipaux concern√©s.
            </p>
            <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <label style="display: flex; align-items: start; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="rgpdConsent" style="margin-top: 4px;">
                    <span style="color: #1e40af; font-size: 14px;">
                        Je m'engage √† utiliser ces donn√©es conform√©ment au RGPD et √† ne les diffuser qu'aux services concern√©s.
                    </span>
                </label>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="proceedExport()" id="rgpdConfirm" disabled>Confirmer</button>
                <button class="btn btn-secondary" onclick="closeRgpdModal()">Annuler</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>

/* ============================================================
   PARTIE 2 - JAVASCRIPT SUIT CI-DESSOUS
   Copiez le contenu de admin-partie2.js ici
   ============================================================ */
// ============================================================
// PARTIE 2 - JAVASCRIPT BASE (CORRIG√â v7.2.2)
// √Ä copier APR√àS la partie 1 dans admin.html
// ============================================================

const API_URL = 'http://localhost:10000';
let token = localStorage.getItem('admin-token');
let allRemarks = [];
let filteredRemarks = [];
let exportType = '';

// Initialisation
if (token) {
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('adminSection').style.display = 'block';
    loadRemarks();
} else {
    document.getElementById('loginSection').style.display = 'block';
}

// RGPD Consent checkbox
document.getElementById('rgpdConsent')?.addEventListener('change', (e) => {
    document.getElementById('rgpdConfirm').disabled = !e.target.checked;
});

// LOGIN
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    try {
        const response = await fetch(`${API_URL}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (data.success && data.data.user.role === 'admin') {
            token = data.data.token;
            localStorage.setItem('admin-token', token);
            location.reload();
        } else {
            document.getElementById('loginError').textContent = 'Acc√®s refus√© - Compte admin requis';
            document.getElementById('loginError').style.display = 'block';
        }
    } catch (error) {
        document.getElementById('loginError').textContent = 'Erreur de connexion';
        document.getElementById('loginError').style.display = 'block';
    }
});

function logout() {
    localStorage.removeItem('admin-token');
    location.reload();
}

// CHARGER LES REMARQUES
async function loadRemarks() {
    try {
        const response = await fetch(`${API_URL}/api/remarks/admin/all`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();
        allRemarks = data.data || [];
        
        // Appliquer les filtres
        applyFilters();
        
        // Mettre √† jour les stats
        updateStats();
        
        // Afficher le tableau
        displayRemarks();
    } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('loading').textContent = 'Erreur de chargement';
    }
}

function applyFilters() {
    const statusFilter = document.getElementById('filterStatus').value;
    const categoryFilter = document.getElementById('filterCategory').value;
    const searchFilter = document.getElementById('filterSearch').value.toLowerCase();
    
    filteredRemarks = allRemarks.filter(r => {
        const matchStatus = !statusFilter || r.status === statusFilter;
        const matchCategory = !categoryFilter || r.category === categoryFilter;
        const matchSearch = !searchFilter || 
            r.title.toLowerCase().includes(searchFilter) ||
            r.description.toLowerCase().includes(searchFilter) ||
            r.name.toLowerCase().includes(searchFilter);
        
        return matchStatus && matchCategory && matchSearch;
    });
}

function updateStats() {
    document.getElementById('statTotal').textContent = allRemarks.length;
    document.getElementById('statEnAttente').textContent = allRemarks.filter(r => r.status === 'En attente').length;
    document.getElementById('statEnCours').textContent = allRemarks.filter(r => r.status === 'En cours').length;
    document.getElementById('statTerminees').textContent = allRemarks.filter(r => r.status === 'Termin√©e').length;
    document.getElementById('statRejetees').textContent = allRemarks.filter(r => r.status === 'Rejet√©e').length;
}

function displayRemarks() {
    const loading = document.getElementById('loading');
    const empty = document.getElementById('empty');
    const table = document.getElementById('remarksTable');
    const tbody = document.getElementById('remarksBody');
    
    loading.style.display = 'none';
    
    if (filteredRemarks.length === 0) {
        empty.style.display = 'block';
        table.style.display = 'none';
        return;
    }
    
    empty.style.display = 'none';
    table.style.display = 'table';
    tbody.innerHTML = '';
    
    filteredRemarks.forEach(remark => {
        const tr = document.createElement('tr');
        const date = new Date(remark.createdAt).toLocaleDateString('fr-FR');
        const statusClass = 'status-' + remark.status.toLowerCase().replace(' ', '-').replace(/√©|√®/g, 'e');
        
        tr.innerHTML = `
            <td>${date}</td>
            <td>${remark.name}</td>
            <td>${remark.category}</td>
            <td><strong>${remark.title}</strong></td>
            <td><span class="status-badge ${statusClass}">${remark.status}</span></td>
            <td>
                <button class="btn btn-secondary btn-small" onclick="editRemark('${remark._id}')">
                    ‚úèÔ∏è Modifier
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function resetFilters() {
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterSearch').value = '';
    loadRemarks();
}

// MODAL MODIFICATION
function editRemark(id) {
    const remark = allRemarks.find(r => r._id === id);
    if (!remark) return;
    
    document.getElementById('editRemarkId').value = remark._id;
    document.getElementById('editTitle').value = remark.title;
    document.getElementById('editDescription').value = remark.description;
    document.getElementById('editStatus').value = remark.status;
    document.getElementById('editPriority').value = remark.priority || 'Moyenne';
    document.getElementById('editAssignedTo').value = remark.assignedTo || '';
    document.getElementById('editAdminNotes').value = remark.adminNotes || '';
    
    // Afficher l'image si pr√©sente
    const imageDiv = document.getElementById('editImage');
    if (remark.image) {
        imageDiv.innerHTML = `
            <div class="form-group">
                <label>Photo jointe</label>
                <img src="${remark.image}" style="width: 100%; border-radius: 8px; margin-top: 10px;">
            </div>
        `;
    } else {
        imageDiv.innerHTML = '';
    }
    
    document.getElementById('editModal').classList.add('active');
}

function closeModal() {
    document.getElementById('editModal').classList.remove('active');
}

async function saveRemark(event) {
    event.preventDefault();
    
    const id = document.getElementById('editRemarkId').value;
    const status = document.getElementById('editStatus').value;
    const priority = document.getElementById('editPriority').value;
    const assignedTo = document.getElementById('editAssignedTo').value;
    const adminNotes = document.getElementById('editAdminNotes').value;
    
    try {
        const response = await fetch(`${API_URL}/api/remarks/admin/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ status, priority, assignedTo, adminNotes })
        });
        
        const data = await response.json();
        
        if (data.success) {
            closeModal();
            loadRemarks();
            alert('Remarque mise √† jour avec succ√®s !');
        } else {
            alert('Erreur: ' + (data.message || 'Impossible de mettre √† jour'));
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur de connexion');
    }
}

// RGPD EXPORT (CORRIG√â v7.2.2)
function confirmExport(type) {
    exportType = type;
    document.getElementById('rgpdConsent').checked = false;
    document.getElementById('rgpdConfirm').disabled = true;
    document.getElementById('rgpdModal').classList.add('active');
}

function closeRgpdModal() {
    document.getElementById('rgpdModal').classList.remove('active');
    // NE PAS r√©initialiser exportType ici !
}

function proceedExport() {
    const type = exportType; // ‚úÖ CORRECTION : Sauvegarder avant de fermer
    closeRgpdModal();
    
    // ‚úÖ CORRECTION : D√©lai pour laisser le modal se fermer
    setTimeout(() => {
        console.log('Export type:', type);
        if (type === 'pdf') {
            exportPDF();
        } else if (type === 'csv') {
            exportCSV();
        }
    }, 100);
}

// EXPORT CSV
function exportCSV() {
    console.log('D√©but export CSV...');
    const headers = ['Date', 'Citoyen', 'Email', 'T√©l√©phone', 'Cat√©gorie', 'Titre', 'Description', 'Statut', 'Priorit√©', 'Assign√© √†', 'Notes admin'];
    const rows = allRemarks.map(r => [
        new Date(r.createdAt).toLocaleDateString('fr-FR'),
        r.name,
        r.email || '',
        r.phone || '',
        r.category,
        r.title,
        r.description,
        r.status,
        r.priority || 'Moyenne',
        r.assignedTo || '',
        r.adminNotes || ''
    ]);
    
    let csv = '\ufeff' + headers.map(h => `"${h}"`).join(',') + '\n';
    rows.forEach(row => {
        csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `saint-remeze-remarques-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    console.log('‚úÖ CSV t√©l√©charg√©');
}

/* ============================================================
   PARTIE 3 - EXPORT PDF SUIT CI-DESSOUS
   Copiez le contenu de admin-partie3.js ici
   ============================================================ */
// ============================================================
// PARTIE 3 - EXPORT PDF PROFESSIONNEL (CORRIG√â v7.2.3)
// √Ä copier APR√àS la partie 2 dans admin.html
// ============================================================

async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Initialisation de l'objet de stats
    let categoryStats = {};
    
    // ===== PAGE 1 - SYNTH√àSE AVEC GRAPHIQUES =====
    
    // Logo
    try {
        const imgData = await getBase64Image('/logo-saint-remeze.png');
        doc.addImage(imgData, 'PNG', 14, 10, 30, 30);
    } catch (e) {
        console.log('Logo non charg√©');
    }
    
    // Titre
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');
    doc.text('Rapport des Remarques', 50, 20);
    
    doc.setFontSize(16);
    doc.text('Commune de Saint-Rem√®ze', 50, 28);
    
    // Date de g√©n√©ration
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    const now = new Date();
    doc.text(`G√©n√©r√© le ${now.toLocaleDateString('fr-FR')} √† ${now.toLocaleTimeString('fr-FR')}`, 50, 35);
    
    // Statistiques textuelles
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('Statistiques', 14, 50);
    
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    const stats = {
        total: allRemarks.length,
        enAttente: allRemarks.filter(r => r.status === 'En attente').length,
        enCours: allRemarks.filter(r => r.status === 'En cours').length,
        terminees: allRemarks.filter(r => r.status === 'Termin√©e').length,
        rejetees: allRemarks.filter(r => r.status === 'Rejet√©e').length
    };
    
    doc.text(`Total : ${stats.total}`, 14, 58);
    doc.text(`En attente : ${stats.enAttente}`, 14, 64);
    doc.text(`En cours : ${stats.enCours}`, 14, 70);
    doc.text(`Termin√©es : ${stats.terminees}`, 14, 76);
    doc.text(`Rejet√©es : ${stats.rejetees}`, 14, 82);
    
    // ‚úÖ CORRECTION : Graphique Statuts (filtrer les 0)
    try {
        const statusLabels = [];
        const statusValues = [];
        const statusColors = [];
        
        if (stats.enAttente > 0) {
            statusLabels.push('En attente');
            statusValues.push(stats.enAttente);
            statusColors.push('#f59e0b');
        }
        if (stats.enCours > 0) {
            statusLabels.push('En cours');
            statusValues.push(stats.enCours);
            statusColors.push('#3b82f6');
        }
        if (stats.terminees > 0) {
            statusLabels.push('Termin√©es');
            statusValues.push(stats.terminees);
            statusColors.push('#10b981');
        }
        if (stats.rejetees > 0) {
            statusLabels.push('Rejet√©es');
            statusValues.push(stats.rejetees);
            statusColors.push('#ef4444');
        }
        
        if (statusValues.length > 0) {
            const statusChartData = await createChartImage('pie', statusLabels, statusValues, statusColors);
            doc.addImage(statusChartData, 'PNG', 14, 90, 80, 80);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('R√©partition par statut', 14, 175);
        }
    } catch (e) {
        console.log('Graphique statuts non cr√©√©:', e);
    }
    
    // ‚úÖ CORRECTION : Graphique Cat√©gories (nettoyer emojis + filtrer 0)
    try {
        // Compter par cat√©gorie en nettoyant les emojis
        categoryStats = {};
        allRemarks.forEach(r => {
            // Retirer TOUS les emojis et pr√©fixes entre crochets
            let cat = r.category
                .replace(/ü§ù|üöó|üé≠|üíß|üè´|üí°|üå≥|üöÆ|üöß|üì¢/g, '')
                .replace(/\[.*?\]/g, '')
                .trim();
            
            // Si la cat√©gorie est vide apr√®s nettoyage, utiliser "Autre"
            if (!cat) cat = 'Autre';
            
            categoryStats[cat] = (categoryStats[cat] || 0) + 1;
        });
        
        // Filtrer les cat√©gories avec 0 remarques et cr√©er les tableaux
        const catLabels = [];
        const catValues = [];
        
        Object.entries(categoryStats).forEach(([cat, count]) => {
            if (count > 0) {
                catLabels.push(cat);
                catValues.push(count);
            }
        });
        
        if (catLabels.length > 0) {
            const catColors = generateColors(catLabels.length);
            const categoryChartData = await createChartImage('pie', catLabels, catValues, catColors);
            doc.addImage(categoryChartData, 'PNG', 110, 90, 80, 80);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('Par cat√©gorie', 110, 175);
        }
    } catch (e) {
        console.log('Graphique cat√©gories non cr√©√©:', e);
    }
    
    // Liste des cat√©gories avec compteurs
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('Cat√©gories :', 14, 185);
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    let yPos = 192;
    
    // Filtrer et afficher seulement les cat√©gories avec des remarques
    Object.entries(categoryStats)
        .filter(([cat, count]) => count > 0)
        .sort((a, b) => b[1] - a[1])  // Trier par nombre d√©croissant
        .forEach(([cat, count]) => {
            if (yPos > 280) return;
            doc.text(`${cat} (${count})`, 14, yPos);
            yPos += 5;
        });
    
    // ===== PAGES SUIVANTES - 1 REMARQUE PAR PAGE =====
    
    for (let i = 0; i < allRemarks.length; i++) {
        const remark = allRemarks[i];
        
        doc.addPage();
        
        // En-t√™te
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text('Mairie de Saint-Rem√®ze - Document interne √† ne diffuser qu\'aux services concern√©s', 14, 10);
        
        // Num√©ro et Titre
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(37, 99, 235);
        const title = `${i + 1}. ${remark.title}`;
        doc.text(title, 14, 20);
        
        // Souligner le titre
        const titleWidth = doc.getTextWidth(title);
        doc.setDrawColor(37, 99, 235);
        doc.setLineWidth(0.5);
        doc.line(14, 22, 14 + titleWidth, 22);
        
        doc.setTextColor(0, 0, 0);
        
        // Date et Citoyen
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Date : ${new Date(remark.createdAt).toLocaleDateString('fr-FR')} √† ${new Date(remark.createdAt).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}`, 14, 28);
        doc.text(`Citoyen : ${remark.name}`, 14, 34);
        
        // ‚úÖ CORRECTION : Cat√©gorie sans emoji
        const cleanCategory = remark.category
            .replace(/ü§ù|üöó|üé≠|üíß|üè´|üí°|üå≥|üöÆ|üöß|üì¢/g, '')
            .replace(/\[.*?\]/g, '')
            .trim() || 'Autre';
        
        // Encadr√© Statut | Priorit√© | Cat√©gorie
        const statusColor = getStatusColor(remark.status);
        doc.setFillColor(statusColor.r, statusColor.g, statusColor.b);
        doc.roundedRect(14, 38, 182, 10, 2, 2, 'F');
        
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        const encadreText = `Statut: ${remark.status} | Priorit√©: ${remark.priority || 'Moyenne'} | Cat√©gorie: ${cleanCategory}`;
        doc.text(encadreText, 16, 44);
        
        doc.setTextColor(0, 0, 0);
        
        // Description
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        let yPos = 55;
        const descLines = doc.splitTextToSize(remark.description, 180);
        descLines.forEach(line => {
            if (yPos > 280) return;
            doc.text(line, 14, yPos);
            yPos += 5;
        });
        
        yPos += 5;
        
        // Photo
        if (remark.image && yPos < 200) {
            try {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'italic');
                doc.text('Photo jointe :', 14, yPos);
                yPos += 5;
                
                const maxWidth = 100;
                const maxHeight = 100;
                doc.addImage(remark.image, 'JPEG', 14, yPos, maxWidth, maxHeight);
                yPos += maxHeight + 5;
            } catch (e) {
                console.log('Photo non ajout√©e:', e);
            }
        }
        
        // Localisation
        if (remark.location && yPos < 270) {
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(37, 99, 235);
            const locText = `Localisation : ${remark.location.latitude}, ${remark.location.longitude}`;
            doc.textWithLink(locText, 14, yPos, {
                url: `https://www.google.com/maps?q=${remark.location.latitude},${remark.location.longitude}`
            });
            yPos += 5;
            doc.setTextColor(0, 0, 0);
        }
        
        // Email et T√©l√©phone
        if (yPos < 275) {
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            if (remark.email) {
                doc.text(`Email : ${remark.email}`, 14, yPos);
                yPos += 5;
            }
            if (remark.phone) {
                doc.text(`T√©l√©phone : ${remark.phone}`, 14, yPos);
                yPos += 5;
            }
        }
        
        // Notes admin
        if (remark.adminNotes && yPos < 270) {
            yPos += 2;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(37, 99, 235);
            doc.text('Notes administrateur : ', 14, yPos);
            doc.setFont('helvetica', 'normal');
            const notesLines = doc.splitTextToSize(remark.adminNotes, 180);
            notesLines.forEach(line => {
                if (yPos > 285) return;
                doc.text(line, 14, yPos);
                yPos += 5;
            });
            doc.setTextColor(0, 0, 0);
        }
        
        // Assign√© √†
        if (remark.assignedTo && yPos < 285) {
            yPos += 2;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text(`Assign√© √† : ${remark.assignedTo}`, 14, yPos);
        }
    }
    
    // Sauvegarder le PDF
    doc.save(`rapport-remarques-${new Date().toISOString().split('T')[0]}.pdf`);
    console.log('‚úÖ PDF g√©n√©r√© avec succ√®s');
}

// Fonction pour cr√©er un graphique et le convertir en image
async function createChartImage(type, labels, data, colors) {
    return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        canvas.width = 400;
        canvas.height = 400;
        const ctx = canvas.getContext('2d');
        
        new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            font: { size: 12 },
                            padding: 10
                        }
                    }
                }
            }
        });
        
        setTimeout(() => {
            resolve(canvas.toDataURL('image/png'));
        }, 500);
    });
}

function getStatusColor(status) {
    const colors = {
        'En attente': { r: 254, g: 243, b: 199 },
        'En cours': { r: 219, g: 234, b: 254 },
        'Termin√©e': { r: 209, g: 250, b: 229 },
        'Rejet√©e': { r: 254, g: 226, b: 226 }
    };
    return colors[status] || { r: 241, g: 245, b: 249 };
}

function generateColors(count) {
    const colors = [
        '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
        '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
    ];
    return colors.slice(0, count);
}

async function getBase64Image(url) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            resolve(canvas.toDataURL('image/png'));
        };
        img.onerror = reject;
        img.src = url;
    });
}

/* ============================================================
   PARTIE 4 - FERMETURE SUIT CI-DESSOUS
   Copiez le contenu de admin-partie4.html ici
   ============================================================ */
// ============================================================
// PARTIE 4 - FERMETURE DU JAVASCRIPT ET HTML
// √Ä copier APR√àS la partie 3 dans admin.html
// ============================================================

    </script>
</body>
</html>
