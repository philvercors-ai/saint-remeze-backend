<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Saint-Rem√®ze</title>
    <style>
        /* CSS D'ORIGINE CONSERV√â ET NETTOY√â */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8fafc; }
        .header { background: white; border-bottom: 1px solid #e2e8f0; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .logo-container { display: flex; align-items: center; gap: 15px; }
        .logo-container img { height: 50px; }
        .header h1 { color: #1e293b; font-size: 24px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 40px; }
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-value { font-size: 36px; font-weight: bold; }
        .stat-label { color: #64748b; font-size: 14px; margin-top: 8px; }
        .filters { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .filters select, .filters input { padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        .remarks-table { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #e2e8f0; color: #1e293b; }
        tr:hover { background: #f8fafc; }
        .status-badge { padding: 5px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; display: inline-block; }
        .status-en-attente { background: #fef3c7; color: #92400e; }
        .status-en-cours { background: #dbeafe; color: #1e40af; }
        .status-terminee { background: #d1fae5; color: #065f46; }
        .status-rejetee { background: #fee2e2; color: #991b1b; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #1e293b; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #475569; }
        .form-group select, .form-group textarea, .form-group input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .loading { text-align: center; padding: 40px; color: #64748b; }
        .empty { text-align: center; padding: 60px; color: #94a3b8; }
        .login-form { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .login-form h1 { color: #1e293b; margin-bottom: 30px; text-align: center; }
        .error { background: #fee2e2; color: #991b1b; padding: 12px; border-radius: 8px; margin-bottom: 20px; }
        
        @media (max-width: 768px) {
            .container { padding: 15px 10px !important; }
            .header { padding: 15px !important; flex-direction: column !important; gap: 10px; align-items: flex-start !important; }
            .stats-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 10px !important; }
            .remarks-table { overflow-x: auto; }
            table { min-width: 800px; }
        }
    </style>
</head>
<body>
    <div id="loginSection" style="display: none;">
        <div class="login-form">
            <h1>Admin Saint-Rem√®ze</h1>
            <div id="loginError" class="error" style="display: none;"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required value="admin@saint-remeze.fr">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="loginPassword" required value="admin123">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Se connecter</button>
            </form>
        </div>
    </div>

    <div id="adminSection" style="display: none;">
        <div class="header">
            <div class="logo-container">
                <img src="/logo-saint-remeze.png" alt="Saint-Rem√®ze" onerror="this.style.display='none'">
                <h1>Dashboard Admin</h1>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="confirmExport('pdf')">üìÑ Export PDF</button>
                <button class="btn btn-success" onclick="confirmExport('csv')">üìä Export CSV</button>
                <button class="btn btn-secondary" onclick="logout()">D√©connexion</button>
            </div>
        </div>

        <div class="container">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
                <div class="stat-card"><div class="stat-value" style="color: #f59e0b;" id="statEnAttente">0</div><div class="stat-label">En attente</div></div>
                <div class="stat-card"><div class="stat-value" style="color: #3b82f6;" id="statEnCours">0</div><div class="stat-label">En cours</div></div>
                <div class="stat-card"><div class="stat-value" style="color: #10b981;" id="statTerminees">0</div><div class="stat-label">Termin√©es</div></div>
                <div class="stat-card"><div class="stat-value" style="color: #ef4444;" id="statRejetees">0</div><div class="stat-label">Rejet√©es</div></div>
            </div>

            <div class="filters">
                <select id="filterStatus" onchange="applyFiltersAndDisplay()">
                    <option value="">Tous les statuts</option>
                    <option value="En attente">En attente</option>
                    <option value="En cours">En cours</option>
                    <option value="Termin√©e">Termin√©e</option>
                    <option value="Rejet√©e">Rejet√©e</option>
                </select>
                <select id="filterCategory" onchange="applyFiltersAndDisplay()">
                    <option value="">Toutes les cat√©gories</option>
                    <option value="ü§ù Aide √† la personne">ü§ù Aide √† la personne</option>
                    <option value="üöó Circulation / Stationnement">üöó Circulation / Stationnement</option>
                    <option value="üíß Eau et Assainissement">üíß Eau et Assainissement</option>
                    <option value="üí° √âclairage public">üí° √âclairage public</option>
                    <option value="üå≥ Espaces verts">üå≥ Espaces verts</option>
                    <option value="üöÆ Propret√©">üöÆ Propret√©</option>
                    <option value="üöß Travaux / Infrastructure">üöß Travaux / Infrastructure</option>
                    <option value="üì¢ Autre">üì¢ Autre</option>
                </select>
                <input type="text" id="filterSearch" placeholder="Rechercher..." onkeyup="applyFiltersAndDisplay()">
                <button class="btn btn-secondary" onclick="resetFilters()">R√©initialiser</button>
            </div>

            <div class="remarks-table">
                <div id="loading" class="loading">Chargement...</div>
                <div id="empty" class="empty" style="display: none;"><h3>Aucune remarque</h3></div>
                <table id="remarksTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Citoyen</th>
                            <th>Cat√©gorie</th>
                            <th>Titre</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="remarksBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Modifier la remarque</h2><button class="close-btn" onclick="closeModal()">&times;</button></div>
            <form id="editForm" onsubmit="saveRemark(event)">
                <input type="hidden" id="editRemarkId">
                <div class="form-group"><label>Titre</label><input type="text" id="editTitle" readonly></div>
                <div class="form-group"><label>Description</label><textarea id="editDescription" readonly></textarea></div>
                <div class="form-group"><label>Statut</label>
                    <select id="editStatus" required>
                        <option value="En attente">En attente</option>
                        <option value="En cours">En cours</option>
                        <option value="Termin√©e">Termin√©e</option>
                        <option value="Rejet√©e">Rejet√©e</option>
                    </select>
                </div>
                <div class="form-group"><label>Priorit√©</label>
                    <select id="editPriority">
                        <option value="Basse">Basse</option>
                        <option value="Moyenne">Moyenne</option>
                        <option value="Haute">Haute</option>
                        <option value="Urgente">Urgente</option>
                    </select>
                </div>
                <div class="form-group"><label>Assign√© √†</label><input type="text" id="editAssignedTo"></div>
                <div class="form-group"><label>Notes administrateur</label><textarea id="editAdminNotes"></textarea></div>
                <div id="editImage"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <div id="rgpdModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2>Consentement RGPD</h2>
            <p style="margin: 20px 0;">Vous allez exporter des donn√©es personnelles. Ces donn√©es sont confidentielles.</p>
            <label style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="checkbox" id="rgpdConsent" onchange="document.getElementById('rgpdConfirm').disabled = !this.checked">
                Je m'engage √† respecter le RGPD.
            </label>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="proceedExport()" id="rgpdConfirm" disabled>Confirmer</button>
                <button class="btn btn-secondary" onclick="closeRgpdModal()">Annuler</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const API_URL = 'https://saint-remeze-backend.onrender.com';
        let token = localStorage.getItem('admin-token');
        let allRemarks = [];
        let filteredRemarks = [];
        let exportType = '';

        // --- INITIALISATION ---
        window.onload = () => {
            if (token) {
                document.getElementById('adminSection').style.display = 'block';
                loadRemarks();
            } else {
                document.getElementById('loginSection').style.display = 'block';
            }
        };

        // --- AUTH ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const res = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (data.success && data.data.user.role === 'admin') {
                    token = data.data.token;
                    localStorage.setItem('admin-token', token);
                    location.reload();
                } else {
                    alert('Acc√®s refus√©');
                }
            } catch (err) { alert('Erreur de connexion'); }
        });

        function logout() { localStorage.removeItem('admin-token'); location.reload(); }

        // --- DONN√âES ---
        async function loadRemarks() {
            try {
                const res = await fetch(`${API_URL}/api/remarks/admin/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                allRemarks = data.data || [];
                applyFiltersAndDisplay();
            } catch (err) { console.error(err); }
        }

        function applyFiltersAndDisplay() {
            const status = document.getElementById('filterStatus').value;
            const category = document.getElementById('filterCategory').value;
            const search = document.getElementById('filterSearch').value.toLowerCase();

            filteredRemarks = allRemarks.filter(r => {
                return (!status || r.status === status) &&
                       (!category || r.category === category) &&
                       (!search || r.title.toLowerCase().includes(search) || r.name.toLowerCase().includes(search));
            });

            updateStats();
            renderTable();
        }

        function updateStats() {
            document.getElementById('statTotal').textContent = allRemarks.length;
            document.getElementById('statEnAttente').textContent = allRemarks.filter(r => r.status === 'En attente').length;
            document.getElementById('statEnCours').textContent = allRemarks.filter(r => r.status === 'En cours').length;
            document.getElementById('statTerminees').textContent = allRemarks.filter(r => r.status === 'Termin√©e').length;
            document.getElementById('statRejetees').textContent = allRemarks.filter(r => r.status === 'Rejet√©e').length;
        }

        function renderTable() {
            const tbody = document.getElementById('remarksBody');
            document.getElementById('loading').style.display = 'none';
            if (filteredRemarks.length === 0) {
                document.getElementById('empty').style.display = 'block';
                document.getElementById('remarksTable').style.display = 'none';
            } else {
                document.getElementById('empty').style.display = 'none';
                document.getElementById('remarksTable').style.display = 'table';
                tbody.innerHTML = filteredRemarks.map(r => `
                    <tr>
                        <td>${new Date(r.createdAt).toLocaleDateString()}</td>
                        <td>${r.name}</td>
                        <td>${r.category}</td>
                        <td>${r.title}</td>
                        <td><span class="status-badge status-${r.status.toLowerCase().replace(/ /g, '-')}">${r.status}</span></td>
                        <td><button class="btn btn-secondary btn-small" onclick="editRemark('${r._id}')">‚úèÔ∏è</button></td>
                    </tr>
                `).join('');
            }
        }

        function resetFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterSearch').value = '';
            applyFiltersAndDisplay();
        }

        // --- MODAL ---
        function editRemark(id) {
            const r = allRemarks.find(x => x._id === id);
            document.getElementById('editRemarkId').value = r._id;
            document.getElementById('editTitle').value = r.title;
            document.getElementById('editDescription').value = r.description;
            document.getElementById('editStatus').value = r.status;
            document.getElementById('editPriority').value = r.priority || 'Moyenne';
            document.getElementById('editAssignedTo').value = r.assignedTo || '';
            document.getElementById('editAdminNotes').value = r.adminNotes || '';
            document.getElementById('editImage').innerHTML = r.image ? `<img src="${r.image}" style="width:100%; margin-top:10px; border-radius:8px;">` : '';
            document.getElementById('editModal').classList.add('active');
        }
        function closeModal() { document.getElementById('editModal').classList.remove('active'); }

        async function saveRemark(e) {
            e.preventDefault();
            const id = document.getElementById('editRemarkId').value;
            const body = {
                status: document.getElementById('editStatus').value,
                priority: document.getElementById('editPriority').value,
                assignedTo: document.getElementById('editAssignedTo').value,
                adminNotes: document.getElementById('editAdminNotes').value
            };
            try {
                await fetch(`${API_URL}/api/remarks/admin/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(body)
                });
                closeModal();
                loadRemarks();
            } catch (err) { alert('Erreur de sauvegarde'); }
        }

        // --- EXPORTS ---
        function confirmExport(type) {
            exportType = type;
            document.getElementById('rgpdModal').classList.add('active');
        }
        function closeRgpdModal() { document.getElementById('rgpdModal').classList.remove('active'); }

        function proceedExport() {
            const type = exportType;
            closeRgpdModal();
            setTimeout(() => {
                if (type === 'pdf') exportPDF();
                else exportCSV();
            }, 200);
        }

        function exportCSV() {
            const headers = ['Date', 'Nom', 'Email', 'Categorie', 'Titre', 'Statut'];
            const rows = allRemarks.map(r => [new Date(r.createdAt).toLocaleDateString(), r.name, r.email, r.category, r.title, r.status]);
            let csvContent = "data:text/csv;charset=utf-8,\ufeff" + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "export-saint-remeze.csv");
            document.body.appendChild(link);
            link.click();
        }

        // --- EXPORT PDF OPTIMIS√â (< 5MO) ---
        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ compress: true });
            const pageWidth = doc.internal.pageSize.getWidth();

            // Utilitaire de compression
            async function compressImg(base64, maxWidth = 800) {
                return new Promise(resolve => {
                    const img = new Image();
                    img.src = base64;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = (maxWidth/w)*h; w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.5));
                    };
                    img.onerror = () => resolve(null);
                });
            }

            // Page 1 : Sommaire
            doc.setFontSize(20).text("Rapport Saint-Rem√®ze", 14, 20);
            doc.setFontSize(10).text(`G√©n√©r√© le ${new Date().toLocaleDateString()}`, 14, 30);
            
            // Boucle sur les remarques
            for (let i = 0; i < allRemarks.length; i++) {
                const r = allRemarks[i];
                doc.addPage();
                doc.setFontSize(14).setTextColor(37, 99, 235).text(`${i+1}. ${r.title}`, 14, 20);
                doc.setFontSize(10).setTextColor(0).text(`Citoyen: ${r.name} | Statut: ${r.status}`, 14, 30);
                
                const desc = doc.splitTextToSize(r.description || "", 180);
                doc.text(desc, 14, 40);
                let currentY = 40 + (desc.length * 5) + 10;

                if (r.image) {
                    const lowRes = await compressImg(r.image);
                    if (lowRes) {
                        const props = doc.getImageProperties(lowRes);
                        const imgW = 120;
                        const imgH = (props.height * imgW) / props.width;
                        if (currentY + imgH > 280) { doc.addPage(); currentY = 20; }
                        doc.addImage(lowRes, 'JPEG', 14, currentY, imgW, imgH);
                    }
                }
            }
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('fr-FR').replace(/\//g, '-');
            doc.save(`export-saint-remeze-${dateStr}.pdf`);
        }
    </script>
</body>
</html>