// ===== MODIFICATIONS Ã€ APPORTER =====

// 1. GET /api/remarks - Exclure les archivÃ©es
router.get('/', optionalAuth, async (req, res) => {
  try {
    console.log('ğŸ“‹ GET /api/remarks');
    const remarks = await Remark.find({ archived: false })  // â† AJOUTER FILTRE
      .populate('user', 'name email')
      .sort({ createdAt: -1 });
    console.log('âœ… Remarques actives:', remarks.length);
    res.json(remarks);
  } catch (error) {
    console.error('âŒ Erreur GET remarks:', error);
    res.status(500).json({ success: false, message: 'Erreur serveur', error: error.message });
  }
});

// 2. GET /api/remarks/admin/all - Exclure les archivÃ©es
router.get('/admin/all', optionalAuth, async (req, res) => {
  try {
    console.log('ğŸ‘‘ GET /api/remarks/admin/all');
    const remarks = await Remark.find({ archived: false })  // â† AJOUTER FILTRE
      .populate('user', 'name email')
      .sort({ createdAt: -1 });
    console.log('âœ… Remarques admin actives:', remarks.length);
    
    // Ajouter info archivable
    const remarksWithInfo = remarks.map(r => ({
      ...r.toObject(),
      isArchivable: r.isArchivable()
    }));
    
    res.json({
      success: true,
      count: remarks.length,
      data: remarksWithInfo
    });
  } catch (error) {
    console.error('âŒ Erreur admin/all:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Erreur serveur', 
      error: error.message,
      data: []
    });
  }
});

// 3. DELETE - VÃ©rifier si supprimable (archivÃ©e > 1 an)
router.delete('/admin/:id', optionalAuth, async (req, res) => {
  try {
    console.log('ğŸ—‘ï¸  DELETE /api/remarks/admin/' + req.params.id);
    
    const remark = await Remark.findById(req.params.id);
    if (!remark) {
      return res.status(404).json({ success: false, message: 'Remarque non trouvÃ©e' });
    }

    // âœ… VÃ‰RIFIER SI SUPPRIMABLE
    if (!remark.isDeletable()) {
      return res.status(403).json({
        success: false,
        message: 'Suppression autorisÃ©e uniquement pour les remarques archivÃ©es depuis plus d\'un an',
        archived: remark.archived,
        archivedAt: remark.archivedAt
      });
    }

    // Supprimer photo
    if (remark.photoUrl) {
      const photoPath = path.join(__dirname, '..', remark.photoUrl);
      if (fs.existsSync(photoPath)) {
        fs.unlinkSync(photoPath);
        console.log('ğŸ“¸ Photo supprimÃ©e');
      }
    }

    await remark.deleteOne();
    console.log('âœ… Remarque supprimÃ©e (archivÃ©e depuis > 1 an):', req.params.id);
    
    res.json({ success: true, message: 'Remarque supprimÃ©e' });
  } catch (error) {
    console.error('âŒ Erreur DELETE admin:', error);
    res.status(500).json({ success: false, message: 'Erreur serveur', error: error.message });
  }
});
